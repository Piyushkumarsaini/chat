{% extends 'chat_app/base.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}
{% block title %}Chat with {{ receiver.name }}{% endblock %}
{% block content %}

<div class="chat-container">

    <!-- Chat Header with presence -->
    <div class="chat-header">
        <div>
            Chat with {{ receiver.name }} &lt;{{ receiver.number }}&gt;
        </div>

        <!-- Presence indicator -->
        <div id="presence-{{ receiver.id }}" class="presence-indicator">
            <span id="presence-dot-{{ receiver.id }}" class="presence-dot"></span>
            <small id="presence-text-{{ receiver.id }}">Checking...</small>
        </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages"
        id="chat-messages"
        data-receiver-id="{{ receiver.id }}"
        data-receiver-online="{{ receiver.is_online }}"
        data-receiver-last-seen="{% if receiver.last_seen %}{{ receiver.last_seen|date:'c' }}{% endif %}"
         data-room-name="{{ room_name }}">
        {% if messages %}
            {% regroup messages by timestamp.date as date_groups %}
            {% with today=now|date:"Y-m-d" %}
                {% for day in date_groups %}
                    <div class="date-header sticky-date">
                        {{ day.grouper|date:"F j, Y" }}
                    </div>

                    {% for msg in day.list %}
                        <div class="message {% if msg.sender.id == current_user.id %}sent{% else %}received{% endif %}"
                             data-msg-id="{{ msg.id }}">
                            <div>{{ msg.content|linebreaksbr }}</div>
                            <small>
                                {{ msg.timestamp|time:"H:i" }}
                                {% if msg.sender.id == current_user.id %}
                                    <span class="ticks">
                                    {% if msg.status == 'sent' %}✓
                                    {% elif msg.status == 'delivered' %}✓✓
                                    {% elif msg.status == 'read' %}<span class="read-ticks">✓✓</span>
                                    {% endif %}
                                    </span>
                                {% endif %}
                            </small>
                        </div>
                    {% endfor %}
                {% endfor %}
            {% endwith %}
        {% else %}
            <div class="no-messages">No messages yet.</div>
        {% endif %}
    </div>

    <!-- Chat Input Form -->
    <form id="chat-form" method="post" class="chat-input">
        {% csrf_token %}
        <textarea id="chat-message-input" name="content" rows="2" placeholder="Type a message..." required></textarea>
        <button id="chat-message-submit" type="submit">Send</button>
    </form>

</div>
<script src="{% static 'js/chat.js' %}"></script>
{% endblock %}