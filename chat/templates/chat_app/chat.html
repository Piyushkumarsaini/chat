{% extends 'chat_app/base.html' %}
{% block title %}Chat with {{ receiver.name }}{% endblock %}
{% block content %}

<style>
/* ===================== Overall Layout ===================== */
.chat-container {
  max-width: 800px;
  margin: 20px auto;
  background: #ece5dd;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  height: 85vh;
  overflow: hidden;
  font-family: "Segoe UI", Arial, sans-serif;
}

/* ===================== Header ===================== */
.chat-header {
  background: #075e54;
  color: #fff;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.chat-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.chat-header-name {
  font-size: 1.1em;
  font-weight: 600;
}

.chat-header-status {
  font-size: 0.9em;
  color: #cfd8dc;
}

.chat-header-icons {
  display: flex;
  align-items: center;
  gap: 15px;
  font-size: 1.2em;
  cursor: pointer;
}

/* ===================== Messages Area ===================== */
.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: #ece5dd;
  display: flex;
  flex-direction: column;
}

/* Date header */
.date-header {
  align-self: center;
  background: #d9fdd3;
  color: #333;
  padding: 5px 12px;
  border-radius: 10px;
  font-size: 0.85em;
  margin: 10px 0;
}

/* Message bubble base */
.message {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 8px;
  margin-bottom: 10px;
  position: relative;
  word-wrap: break-word;
}

/* Received message (left) */
.message.received {
  background: #fff;
  align-self: flex-start;
  border-top-left-radius: 0;
}

/* Sent message (right) */
.message.sent {
  background: #dcf8c6;
  align-self: flex-end;
  border-top-right-radius: 0;
}

/* Deleted message */
.message.deleted {
  font-style: italic;
  color: #777;
  background: #e6e6e6;
}

/* Timestamp */
.message small {
  display: block;
  text-align: right;
  font-size: 0.75em;
  color: #888;
  margin-top: 4px;
}

/* Double ticks (sent/delivered/read) */
.ticks {
  margin-left: 5px;
  color: #777;
}
.ticks.read {
  color: #34b7f1;
}

/* Hover delete icon */
.delete-btn {
  position: absolute;
  top: 5px;
  right: 6px;
  background: transparent;
  border: none;
  color: #777;
  cursor: pointer;
  display: none;
}
.message.sent:hover .delete-btn {
  display: block;
}

/* ===================== Input Section ===================== */
.chat-input {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  background: #f0f0f0;
  border-top: 1px solid #ccc;
}

.chat-input textarea {
  flex: 1;
  resize: none;
  border-radius: 20px;
  border: none;
  padding: 10px 15px;
  font-size: 1em;
  outline: none;
}

.chat-input button {
  background: #25d366;
  border: none;
  color: white;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  font-size: 1.2em;
  margin-left: 10px;
  cursor: pointer;
}

.chat-input button:hover {
  background: #20b358;
}
</style>

<!-- ===================== MAIN CHAT CONTAINER ===================== -->
<div class="chat-container">

    <!-- Chat Header with presence -->
    <div class="chat-header">
        <div class="chat-header-left">
        <img src="https://www.gravatar.com/avatar/{{ receiver.id }}?d=identicon" alt="profile">
        <div>
            <div class="chat-header-name">{{ receiver.name }}</div>

            <!-- Presence Section (restored from your old code) -->
            <div id="presence-{{ receiver.id }}" class="presence-status">
            <span id="presence-dot-{{ receiver.id }}" class="presence-dot"></span>
            <small id="presence-text-{{ receiver.id }}">Checking...</small>
            </div>
        </div>
    </div>

    <div class="chat-header-icons">
      <i class="fa fa-search"></i>
      <i class="fa fa-phone"></i>
      <i class="fa fa-video"></i>
      <i class="fa fa-ellipsis-v"></i>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="chat-messages" id="chat-messages">

    {% if messages %}
      {% regroup messages by timestamp.date as date_groups %}
      {% for day in date_groups %}
        <div class="date-header">
          {{ day.grouper|date:"l, F j" }}
        </div>

        {% for msg in day.list %}
          <div class="message 
                      {% if msg.is_deleted %}deleted{% elif msg.sender.id == current_user.id %}sent{% else %}received{% endif %}"
               data-msg-id="{{ msg.id }}">
            {% if msg.is_deleted %}
              <em>This message has been deleted</em>
            {% else %}
              {{ msg.content|linebreaksbr }}
            {% endif %}

            {% if msg.sender.id == current_user.id %}
              <button class="delete-btn" title="Delete">üóëÔ∏è</button>
            {% endif %}

            <small>
              {{ msg.timestamp|time:"h:i A" }}
              {% if msg.sender.id == current_user.id %}
                <span class="ticks 
                  {% if msg.status == 'read' %}read{% endif %}">
                  {% if msg.status == 'sent' %}‚úì{% elif msg.status == 'delivered' %}‚úì‚úì{% elif msg.status == 'read' %}‚úì‚úì{% endif %}
                </span>
              {% endif %}
            </small>
          </div>
        {% endfor %}
      {% endfor %}
    {% else %}
      <div style="text-align:center; color:#888;">No messages yet.</div>
    {% endif %}
  </div>

  <!-- INPUT AREA -->
  <form id="chat-form" method="post" class="chat-input">
    {% csrf_token %}
    <textarea id="chat-message-input" name="content" rows="1" placeholder="Type your message..." required></textarea>
    <button id="chat-message-submit" type="submit">
      <i class="fa fa-paper-plane"></i>
    </button>
  </form>

</div>

<!-- JavaScript -->
<script>
    const roomName = "{{ room_name }}";
    const meId = Number("{{ current_user.id }}");        // logged in user (this browser)
    const otherUserId = Number("{{ receiver.id }}");    // the chat partner

    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.host + '/ws/chat/' + roomName + '/'
    );

    const messagesContainer = document.getElementById('chat-messages');

    // Helper to update ticks for a message element with given msgId
    function updateTicksForMsg(msgId, newStatus) {
        if (!msgId) return;
        const elem = document.querySelector(`[data-msg-id='${msgId}']`);
        if (!elem) return;
        const ticksSpan = elem.querySelector('.ticks');
        if (!ticksSpan) return;

        if (newStatus === 'sent') ticksSpan.innerHTML = '‚úì';
        else if (newStatus === 'delivered') ticksSpan.innerHTML = '‚úì‚úì';
        else if (newStatus === 'read') ticksSpan.innerHTML = "<span style='color:#4fc3f7;'>‚úì‚úì</span>";
    }

    // Create DOM for a message (used for incoming messages)
    function createMessageDiv(msgText, isSender, timestampText, status, msgId) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', isSender ? 'sent' : 'received');
        if (msgId) msgDiv.setAttribute('data-msg-id', msgId);
        msgDiv.style.cssText = `
            margin-bottom:12px;max-width:70%;padding:10px 16px;border-radius:18px;clear:both;
            ${isSender ? 'background:#dcf8c6;margin-left:auto;text-align:right;' : 'background:#fff;margin-right:auto;text-align:left;border:1px solid #ddd;'}
        `;
        const ticksHtml = isSender ? (status === 'read' ? "<span style='color:#4fc3f7;'>‚úì‚úì</span>" : (status === 'delivered' ? '‚úì‚úì' : '‚úì')) : '';
        msgDiv.innerHTML = `<div>${msgText}</div><small style="color:#888;">${timestampText} <span class="ticks">${ticksHtml}</span></small>`;
        return msgDiv;
    }

    // Update presence UI in header for the receiver
    function updatePresenceUI(userId, isOnline, lastSeen) {
        // we only show presence of the chat partner in header (otherUserId)
        if (Number(userId) !== otherUserId) return;
        const dot = document.getElementById(`presence-dot-${otherUserId}`);
        const text = document.getElementById(`presence-text-${otherUserId}`);
        if (!dot || !text) return;

        if (isOnline) {
            dot.style.background = '#2ecc71'; // green
            text.textContent = 'Online';
            return;
        }

        // Offline state
        dot.style.background = '#bdc3c7';
        if (!lastSeen) {
            text.textContent = 'Offline';
            return;
        }
        
        const lastSeenDate = new Date(lastSeen);
        const now = new Date();
        const diffMs = now - lastSeenDate;
        const diffMinutes = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);

        const formattedTime = lastSeenDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        const formattedDate = lastSeenDate.toLocaleDateString([], { month: 'short', day: 'numeric' });

        if (diffMinutes < 1) {
            text.textContent = 'Last seen just now';
        } else if (diffMinutes < 60) {
            text.textContent = `Last seen ${diffMinutes} min ago`;
        } else if (diffHours < 24 && now.getDate() === lastSeenDate.getDate()) {
            text.textContent = `Last seen today ${formattedTime}`;
        } else if (diffDays === 1) {
            text.textContent = `Last seen yesterday ${formattedTime}`;
        } else {
            text.textContent = `Last seen on ${formattedDate}, ${formattedTime}`;
        }
    }


    chatSocket.onopen = function () {
        console.log("WebSocket connected");

        // Inform server this user is connected to the chat -> server may mark messages delivered
        chatSocket.send(JSON.stringify({
            'action': 'receiver_connected',
            'receiver_id': meId
        }));

        // Immediately mark messages read (optional; we also do this on focus/visibility)
        chatSocket.send(JSON.stringify({
            'action': 'mark_read',
            'reader_id': meId,
            'other_user_id': otherUserId
        }));
    };

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const eventType = data.event;

        if (eventType === 'chat_message') {
            const message = data.message;
            const sender_id = Number(data.sender_id);
            const receiver_id = Number(data.receiver_id);
            const isSender = sender_id === meId;
            const status = data.status;
            const msgId = data.msg_id;
            const ts = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';

            const msgDiv = createMessageDiv(message, isSender, ts, status, msgId);
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // If this client is the receiver of this message, ask server to mark delivered
            if (!isSender && receiver_id === meId) {
                chatSocket.send(JSON.stringify({
                    'action': 'receiver_connected',
                    'receiver_id': meId
                }));
            }
        } else if (eventType === 'status_update') {
            const ids = data.msg_ids || [];
            const newStatus = data.new_status;
            ids.forEach(id => updateTicksForMsg(id, newStatus));
        } else if (eventType === 'presence_update') {
            // presence update: contains user_id, is_online, optional last_seen
            updatePresenceUI(data.user_id, data.is_online, data.last_seen);
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Send message
    document.getElementById('chat-form').onsubmit = function (e) {
        e.preventDefault();
        const inputField = document.getElementById('chat-message-input');
        const message = inputField.value.trim();
        if (message === '') return;

        chatSocket.send(JSON.stringify({
            'action': 'send_message',
            'message': message,
            'sender_id': meId,
            'receiver_id': otherUserId
        }));

        inputField.value = '';
    };

    // Mark messages read when window/tab gets focus or becomes visible
    function markReadNow() {
        chatSocket.send(JSON.stringify({
            'action': 'mark_read',
            'reader_id': meId,
            'other_user_id': otherUserId
        }));
    }

    window.addEventListener('focus', markReadNow);
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') markReadNow();
    });

    // Optional: scroll to bottom on load
    window.onload = function () {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // set initial presence UI from server-rendered data if available
        {% if receiver.is_online %}
            updatePresenceUI({{ receiver.id }}, true, null);
        {% elif receiver.last_seen %}
            updatePresenceUI({{ receiver.id }}, false, "{{ receiver.last_seen|date:'c' }}");
        {% else %}
            updatePresenceUI({{ receiver.id }}, false, null);
        {% endif %}
    };
</script>
{% endblock %}
